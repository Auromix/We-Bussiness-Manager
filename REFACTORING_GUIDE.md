# æ¶æ„é‡æ„æŒ‡å— - æ”¯æŒå¤šé¡¹ç›®å¤ç”¨

## ğŸ¯ é‡æ„ç›®æ ‡

å°†ä»£ç é‡æ„ä¸ºå¯å¤ç”¨çš„æ¶æ„ï¼Œä½¿å¾—ï¼š
1. **LLM è°ƒç”¨** - å®Œå…¨ç‹¬ç«‹ï¼Œå¯æ›¿æ¢
2. **å¾®ä¿¡é›†æˆ** - å®Œå…¨ç‹¬ç«‹ï¼Œå¯æ›¿æ¢
3. **æ•°æ®åº“** - é€šç”¨æ“ä½œç‹¬ç«‹ï¼Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»
4. **ä¸šåŠ¡é€»è¾‘** - å®Œå…¨ç‹¬ç«‹ï¼Œæ–°é¡¹ç›®åªéœ€å®ç°æ¥å£

## ğŸ“ æ–°æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ ¸å¿ƒæ¡†æ¶å±‚ (å¯å¤ç”¨)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WeChat Bot  â”‚  â”‚ LLM Parser   â”‚  â”‚  Pipeline    â”‚  â”‚
â”‚  â”‚  (å¯æ›¿æ¢)    â”‚  â”‚  (å¯æ›¿æ¢)    â”‚  â”‚  (é€šç”¨)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚   BusinessLogicAdapter (æ¥å£)        â”‚          â”‚
â”‚         â”‚   - save_business_record()           â”‚          â”‚
â”‚         â”‚   - get_records_by_date()           â”‚          â”‚
â”‚         â”‚   - generate_summary()              â”‚          â”‚
â”‚         â”‚   - handle_command()                â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸šåŠ¡é€»è¾‘å±‚ (é¡¹ç›®ç‰¹å®šï¼Œå¯æ›¿æ¢)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TherapyStoreAdapter (å½“å‰é¡¹ç›®)                     â”‚  â”‚
â”‚  â”‚  - å®ç° BusinessLogicAdapter æ¥å£                  â”‚  â”‚
â”‚  â”‚  - è°ƒç”¨ db.repository çš„ä¸šåŠ¡æ–¹æ³•                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  æ–°é¡¹ç›®åªéœ€è¦:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NewProjectAdapter (æ–°é¡¹ç›®)                        â”‚  â”‚
â”‚  â”‚  - å®ç° BusinessLogicAdapter æ¥å£                  â”‚  â”‚
â”‚  â”‚  - å®ç°è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ BaseRepository  â”‚  â”‚  Repository     â”‚              â”‚
â”‚  â”‚ (é€šç”¨æ“ä½œ)      â”‚  â”‚  (ä¸šåŠ¡ç‰¹å®š)      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ é‡æ„å†…å®¹

### 1. åˆ›å»ºä¸šåŠ¡é€»è¾‘é€‚é…å™¨æ¥å£ âœ…

**æ–‡ä»¶**: `core/business_adapter.py`

```python
class BusinessLogicAdapter(ABC):
    """ä¸šåŠ¡é€»è¾‘é€‚é…å™¨æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def save_business_record(...)
    @abstractmethod
    def get_records_by_date(...)
    @abstractmethod
    def generate_summary(...)
    @abstractmethod
    def handle_command(...)
```

### 2. åˆ›å»ºä¸šåŠ¡é€»è¾‘å®ç° âœ…

**æ–‡ä»¶**: `business/therapy_store_adapter.py`

- å®ç° `BusinessLogicAdapter` æ¥å£
- åŒ…å«å½“å‰é¡¹ç›®çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
- æ–°é¡¹ç›®å¯ä»¥åˆ›å»ºç±»ä¼¼çš„é€‚é…å™¨

### 3. é‡æ„ Pipeline âœ…

**æ–‡ä»¶**: `parsing/pipeline.py`

- ç§»é™¤ç›´æ¥è°ƒç”¨ `db.save_service_record` ç­‰ä¸šåŠ¡æ–¹æ³•
- é€šè¿‡ `BusinessLogicAdapter` è°ƒç”¨ä¸šåŠ¡é€»è¾‘
- Pipeline ä¸å†ä¾èµ–å…·ä½“ä¸šåŠ¡é€»è¾‘

### 4. é‡æ„ CommandHandler âœ…

**æ–‡ä»¶**: `core/command_handler.py`

- ç§»é™¤ç›´æ¥ä¾èµ– `SummaryService` ç­‰ä¸šåŠ¡æœåŠ¡
- é€šè¿‡ `BusinessLogicAdapter` è°ƒç”¨ä¸šåŠ¡é€»è¾‘

### 5. åˆ›å»ºä¸šåŠ¡é…ç½®æ¥å£ âœ…

**æ–‡ä»¶**: `config/business_config.py`

- å®šä¹‰ `BusinessConfig` æ¥å£
- å½“å‰é¡¹ç›®å®ç° `TherapyStoreConfig`
- æ–°é¡¹ç›®å¯ä»¥å®ç°è‡ªå·±çš„é…ç½®

### 6. é‡æ„ Preprocessor âœ…

**æ–‡ä»¶**: `parsing/preprocessor.py`

- ä» `BusinessConfig` è·å–å…³é”®è¯å’Œæ¨¡å¼
- ä¸å†ç¡¬ç¼–ç ä¸šåŠ¡ç‰¹å®šçš„å†…å®¹

## ğŸ“‹ æ–°é¡¹ç›®è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºä¸šåŠ¡é€»è¾‘é€‚é…å™¨

```python
# business/new_project_adapter.py
from core.business_adapter import BusinessLogicAdapter

class NewProjectAdapter(BusinessLogicAdapter):
    """æ–°é¡¹ç›®çš„ä¸šåŠ¡é€»è¾‘é€‚é…å™¨"""
    
    def save_business_record(self, record_type: str, data: Dict[str, Any], ...):
        # å®ç°æ–°é¡¹ç›®çš„ä¸šåŠ¡é€»è¾‘
        pass
    
    def get_records_by_date(self, target_date, record_types=None):
        # å®ç°æ–°é¡¹ç›®çš„æŸ¥è¯¢é€»è¾‘
        pass
    
    # ... å®ç°å…¶ä»–æ–¹æ³•
```

### æ­¥éª¤ 2: åˆ›å»ºä¸šåŠ¡é…ç½®

```python
# config/new_project_config.py
from config.business_config import BusinessConfig

class NewProjectConfig(BusinessConfig):
    """æ–°é¡¹ç›®çš„ä¸šåŠ¡é…ç½®"""
    
    def get_service_types(self):
        # è¿”å›æ–°é¡¹ç›®çš„æœåŠ¡ç±»å‹
        pass
    
    def get_llm_system_prompt(self):
        # è¿”å›æ–°é¡¹ç›®çš„ LLM æç¤ºè¯
        pass
    
    # ... å®ç°å…¶ä»–é…ç½®æ–¹æ³•
```

### æ­¥éª¤ 3: åˆ›å»ºæ•°æ®åº“æ¨¡å‹

```python
# db/new_project_models.py
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

# å®šä¹‰æ–°é¡¹ç›®çš„æ•°æ®åº“æ¨¡å‹
class NewProjectRecord(Base):
    # ...
    pass
```

### æ­¥éª¤ 4: åˆ›å»ºæ•°æ®åº“ Repository

```python
# db/new_project_repository.py
from db.base_repository import BaseRepository

class NewProjectRepository(BaseRepository):
    """æ–°é¡¹ç›®çš„æ•°æ®åº“è®¿é—®å±‚"""
    
    def save_new_project_record(self, data):
        # å®ç°æ–°é¡¹ç›®çš„æ•°æ®åº“æ“ä½œ
        pass
```

### æ­¥éª¤ 5: ä¿®æ”¹ä¸»ç¨‹åº

```python
# main.py
from business.new_project_adapter import NewProjectAdapter
from config.new_project_config import NewProjectConfig

# ä½¿ç”¨æ–°é¡¹ç›®çš„é€‚é…å™¨å’Œé…ç½®
business_adapter = NewProjectAdapter(db_repo)
business_config = NewProjectConfig()

# å…¶ä»–ä»£ç ä¸éœ€è¦ä¿®æ”¹
pipeline = MessagePipeline(preprocessor, llm_parser, db_repo, business_adapter)
```

## âœ… é‡æ„æ£€æŸ¥æ¸…å•

### æ ¸å¿ƒæ¡†æ¶å±‚ï¼ˆå¯å¤ç”¨ï¼‰

- [x] `core/business_adapter.py` - ä¸šåŠ¡é€»è¾‘é€‚é…å™¨æ¥å£
- [x] `parsing/pipeline.py` - é€šè¿‡é€‚é…å™¨è°ƒç”¨ä¸šåŠ¡é€»è¾‘
- [x] `core/command_handler.py` - é€šè¿‡é€‚é…å™¨è°ƒç”¨ä¸šåŠ¡é€»è¾‘
- [x] `core/scheduler.py` - é€šè¿‡é€‚é…å™¨è°ƒç”¨ä¸šåŠ¡é€»è¾‘
- [x] `parsing/preprocessor.py` - ä»é…ç½®è·å–å…³é”®è¯
- [x] `config/business_config.py` - ä¸šåŠ¡é…ç½®æ¥å£

### ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆé¡¹ç›®ç‰¹å®šï¼‰

- [x] `business/therapy_store_adapter.py` - å½“å‰é¡¹ç›®é€‚é…å™¨
- [ ] `business/__init__.py` - ä¸šåŠ¡é€»è¾‘åŒ…

### æ•°æ®åº“å±‚

- [x] `db/base_repository.py` - åŸºç¡€æ•°æ®åº“æ“ä½œ
- [x] `db/repository.py` - å½“å‰é¡¹ç›®çš„ä¸šåŠ¡æ•°æ®åº“æ“ä½œï¼ˆä¿ç•™ï¼‰

## ğŸ¯ å¤ç”¨æ€§éªŒè¯

### éªŒè¯ç‚¹ 1: LLM è°ƒç”¨ç‹¬ç«‹ âœ…

- LLM è§£æå™¨ä½¿ç”¨æ¥å£ï¼Œæ”¯æŒå¤šç§ LLM
- å¯ä»¥è½»æ¾æ›¿æ¢ä¸ºå…¶ä»– LLM æœåŠ¡

### éªŒè¯ç‚¹ 2: å¾®ä¿¡é›†æˆç‹¬ç«‹ âœ…

- Bot ç±»æä¾›æŠ½è±¡æ¥å£
- æ”¯æŒ Mock æ¨¡å¼
- å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å¾®ä¿¡æ¡¥æ¥æ–¹æ¡ˆ

### éªŒè¯ç‚¹ 3: æ•°æ®åº“ç‹¬ç«‹ âš ï¸

- ä½¿ç”¨ SQLAlchemy ORMï¼Œå¯ä»¥åˆ‡æ¢æ•°æ®åº“
- Repository åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆéœ€è¦è¿›ä¸€æ­¥åˆ†ç¦»ï¼‰

### éªŒè¯ç‚¹ 4: ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹ âœ…

- é€šè¿‡ `BusinessLogicAdapter` æ¥å£è§£è€¦
- æ–°é¡¹ç›®åªéœ€å®ç°æ¥å£ï¼Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç 

## ğŸ“ ä¸‹ä¸€æ­¥

1. æµ‹è¯•é‡æ„åçš„ä»£ç 
2. åˆ›å»ºæ–°é¡¹ç›®æ¨¡æ¿
3. ç¼–å†™è¿ç§»æŒ‡å—
4. æ›´æ–°æ–‡æ¡£

